<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Task Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <style>
        html {
          scroll-behavior: smooth;
        }

        body {
          margin: 0;
          overflow-x: hidden;
          background-color: #f8f9fa;
        }

        header.navbar {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          z-index: 1050;
          height: 56px;
        }

        .sidebar {
          position: fixed;
          top: 56px;
          left: 0;
          width: 240px;
          height: calc(100vh - 56px);
          background-color: #343a40;
          color: #fff;
          overflow-y: auto;
        }

        .sidebar a {
          color: #adb5bd;
          text-decoration: none;
          display: block;
          padding: 12px 20px;
        }

        .sidebar a:hover {
          background-color: #495057;
          color: #fff;
        }

        .content {
          margin-left: 240px;
          margin-top: 76px;
          padding: 20px;
        }

        textarea {
          height: 80px !important;
        }
    </style>
</head>

<body>
<!-- Navigation Header -->
<header class="navbar navbar-expand-lg navbar-dark px-4 shadow-sm"
        style="background: linear-gradient(to right, #2d2d2d, #1c1c1c);">
    <a class="navbar-brand fw-semibold text-white" href="/dashboard">
        <i class="bi bi-speedometer2 me-2"></i> Task Management
    </a>
    <div class="ms-auto d-flex align-items-center">
        <span class="text-white me-3">
      <i class="bi bi-person-circle me-1"></i> Welcome
    </span>
    </div>
</header>
<!-- Sidebar -->
<div class="sidebar">
    <h5 class="px-3 py-2 text-white border-bottom">Dashboard</h5>
    <a href="#" onclick="showForm('addForm')"><i class="bi bi-plus-circle me-2"></i> ADD Tasks</a>
<!--    <a href="#" onclick="showForm('updateForm')"><i class="bi bi-pencil-square me-2"></i> UPDATE Task</a>-->
    <a href="#" onclick="showForm('taskTable')"><i class="bi bi-list-task me-2"></i> VIEW Tasks</a>
<!--    <a href="/profile"><i class="bi bi-person-circle me-2"></i> Profile</a>-->
<!--    <a href="/logout"><i class="bi bi-box-arrow-right me-2"></i> Logout</a>-->
</div>

<!-- Main Content -->
<div class="content">
    <div class="container">
        <!-- Update Task Form -->
<!--        <div id="updateForm" style="display: none;">-->
            <div id="updateForm" th:if="${formToShow == 'updateForm'}">

            <h3 class="text-center text-primary mb-4">Update Task</h3>
            <div class="row justify-content-center">
                <div class="col-md-8 bg-white p-4 border rounded shadow-sm">
                    <!--                    <form th:action="@{'/tasks/' + ${task.id}}" th:object="${task}" method="post">-->
                    <!--                    <form th:action="@{/tasks/update}" th:object="${task}" method="post">-->
                    <form th:action="@{/tasks/update}" method="post" th:object="${task}">
                        <input type="hidden" th:field="*{id}" />
                        <!--                        <input type="hidden" name="_method" value="put" />-->
                        <!--                        <input type="hidden" th:field="*{id}" />-->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" th:field="*{title}" class="form-control" id="title" placeholder="Title">
                                    <label for="title">Task Title</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="date" th:field="*{dueDate}" class="form-control" id="dueDate">
                                    <label for="dueDate">Due Date</label>
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="form-floating">
                    <textarea th:field="*{description}" class="form-control" id="description"
                              placeholder="Description"></textarea>
                                    <label for="description">Description</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select th:field="*{status}" class="form-select" id="status">
                                        <option value="PENDING">Pending</option>
                                        <option value="IN_PROGRESS">In Progress</option>
                                        <option value="COMPLETED">Completed</option>
                                    </select>
                                    <label for="status">Status</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <textarea th:field="*{remarks}" class="form-control" id="remarks" placeholder="Remarks"></textarea>
                                    <label for="remarks">Remarks</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" th:field="*{updatedBy}" class="form-control" id="updatedBy"
                                           placeholder="Updated by">
                                    <label for="updatedBy">Last Updated By</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <!--                                <div class="form-floating">-->
                                <!--                                    <input type="datetime-local" th:if="${task.updatedAt != null}"-->
                                <!--                                           th:value="${#dates.format(task.updatedAt, 'yyyy-MM-dd''T''HH:mm')}" class="form-control"-->
                                <!--                                           id="updatedAt" readonly />-->
                                <!--                                    <input type="datetime-local" th:unless="${task.updatedAt != null}" value="" class="form-control"-->
                                <!--                                           id="updatedAt" readonly />-->
                                <!--                                    <label for="updatedAt">Last Updated On</label>-->
                                <!--                                </div>-->
                            </div>
                        </div>
                        <div class="mt-4 text-end">
                            <button type="submit" class="btn btn-primary px-4">Update Task</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!--Add Task Form -->
        <div id="addForm" class="container mt-4">
            <h4 class="text-center text-primary fw-bold mb-4">Add Task</h4>
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="bg-white p-4 border rounded shadow-sm">
                        <form th:action="@{/add-task}" th:object="${newTask}" method="post">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" th:field="*{name}" class="form-control" id="name" placeholder="Full name">
                                        <label for="name">Name</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" th:field="*{createdBy}" class="form-control" id="createdBy"
                                               placeholder="Created by">
                                        <label for="createdBy">Created By</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="text" th:field="*{title}" class="form-control" id="title" placeholder="Title">
                                        <label for="title">Title</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- <div class="form-floating">
                                                        <input type="date" th:value="${#temporals.format(task.createdAt, 'yyyy-MM-dd')}"
                                                               class="form-control" id="createdAt" name="createdAt" readonly>
                                                        <label for="createdAt">Created At</label>
                                                    </div> -->
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                      <textarea th:field="*{description}" class="form-control" id="description"
                                placeholder="Description" style="height: 120px"></textarea>
                                        <label for="description">Description</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <select th:field="*{status}" class="form-select" id="status">
                                            <option value="PENDING">Pending</option>
                                            <option value="IN_PROGRESS">In Progress</option>
                                            <option value="COMPLETED">Completed</option>
                                        </select>
                                        <label for="status">Status</label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-floating">
                                        <input type="date" th:field="*{dueDate}" class="form-control" id="dueDate" required>
                                        <label for="dueDate">Due Date</label>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="form-floating">
                      <textarea th:field="*{remarks}" class="form-control" id="remarks" placeholder="Remarks"
                                style="height: 120px"></textarea>
                                        <label for="remarks">Remarks</label>
                                    </div>
                                </div>
                                <div class="col-12 text-end">
                                    <button type="submit" class="btn btn-primary px-4">Submit</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!--  -->
        <div id="taskTable" class="container mt-5">
            <h2 class="mb-4 text-center text-primary">Task List</h2>
            <div class="mb-4">
                <form method="get" th:action="@{/tasks}" class="row justify-content-center align-items-end g-3">
                    <div class="col-auto">
                        <label for="keyword" class="form-label fw-bold" style="color: #3a3a3a;">Search Tasks</label>
                    </div>
                    <div class="col-md-6">
                        <input type="text"
                               id="keyword"
                               name="keyword"
                               class="form-control shadow-sm"
                               th:value="${keyword}"
                               placeholder="Title"
                               style="background-color: #f7f3f0; border: 1px solid #c5bfb8; color: #333;">
                    </div>
                    <div class="col-auto">
                        <button type="submit"
                                class="btn px-4 shadow-sm"
                                style="background-color: #444444; color: white; border: none;">
                            <i class="bi bi-search me-1"></i> Search
                        </button>
                    </div>
                </form>
            </div>
<!--            Table-->
            <div class="row justify-content-center">
                <div class="col-lg-11">
                    <div class="table-responsive bg-white shadow-sm rounded p-4 border border-2 border-light">
                        <table class="table table-bordered table-hover table-striped align-middle small">
                            <thead style="background-color: #e3f2fd;" class="text-center text-dark fw-semibold">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Created On</th>
                                <th>Updated</th>
                                <th>Last Update On</th>
                                <th>Last Updated By</th>
                                <th>Created By</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="task : ${taskList}"
                                th:id="'task-' + ${task.id}"
                                th:classappend="${updatedTaskId} == ${task.id} ? 'table-success' : ''">
<!--                                <td class="text-center" th:text="${iterStat.index + 1}"></td>-->
                                <td th:text="${task.id}"></td>
                                <td th:text="${task.name}"></td>
                                <td th:text="${task.title}"></td>
                                <td th:text="${task.description}"></td>
                                <td th:text="${task.dueDate}"></td>
                                <td th:text="${task.status}"></td>
                                <td th:text="${task.remarks}"></td>
                                <td th:text="${task.createdAt}"></td>
                                <td th:text="${task.updated ? 'âœ“' : 'âœ—'}"></td>
                                 <td>[[${task.updatedAt.format(T(java.time.format.DateTimeFormatter).ofPattern('yyyy-MM-dd HH:mm'))}]]</td>
                                <td th:text="${task.createdBy}"></td>
                                <td th:text="${task.updatedBy}"></td> <!-- âœ… correct -->
                                <td>
<!--                                    <a th:href="@{/tasks/update(id=${task.id})}" class="btn btn-sm btn-warning">-->
<!--                                        <i class="bi bi-pencil-square"></i> Edit-->
<!--                                    </a>-->
                                    <!-- ðŸ”˜ Edit Task Trigger Button -->
                                    <a th:href="@{/tasks/edit(id=${task.id})}" class="btn btn-sm btn-warning">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </a>
                                    <!--                                     <a th:href="@{'/tasks/edit/' + ${task.id}}" class="btn btn-sm btn-warning text-white">Update</a>-->
                                    <form th:action="@{'/tasks/delete/' + ${task.id}}" method="post" style="display:inline;"
                                          onsubmit="return confirm('Are you sure you want to delete this task?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger text-nowrap">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!-- Scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script>
            flatpickr(".flatpickr-dt", {
              enableTime: true,
              dateFormat: "Y-m-d H:i",
              allowInput: false
            });
            function showForm(formId) {
              const sections = ['addForm', 'updateForm', 'taskTable'];
              sections.forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                  section.style.display = (id === formId) ? 'block' : 'none';
                }
              });
            }
            window.onload = function () {
              let taskExists = /*[[${task != null}]]*/ false;
              if (taskExists) {
                showForm('updateForm');
              } else {
                showForm('taskTable');
              }
            };
        </script>
</body>
</html>